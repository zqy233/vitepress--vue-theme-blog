import{_ as s,o as n,c as a,a as l}from"./app.bfa9bd4b.js";const u=JSON.parse('{"title":"源码阅读","description":"","frontmatter":{},"headers":[{"level":2,"title":"插件激活函数activate","slug":"插件激活函数activate","link":"#插件激活函数activate","children":[{"level":3,"title":"路径packages/extension/src/extensionMain.ts","slug":"路径packages-extension-src-extensionmain-ts","link":"#路径packages-extension-src-extensionmain-ts","children":[]}]},{"level":2,"title":"setupChangeListener函数解析","slug":"setupchangelistener函数解析","link":"#setupchangelistener函数解析","children":[]},{"level":2,"title":"wordsAtOffsets有啥用","slug":"wordsatoffsets有啥用","link":"#wordsatoffsets有啥用","children":[]},{"level":2,"title":"请求服务器自动完成标签重命名的结果","slug":"请求服务器自动完成标签重命名的结果","link":"#请求服务器自动完成标签重命名的结果","children":[]},{"level":2,"title":"updateWordsAtOffset：更新标签信息的函数","slug":"updatewordsatoffset-更新标签信息的函数","link":"#updatewordsatoffset-更新标签信息的函数","children":[]}],"relativePath":"6.源码阅读/vscode-auto-rename-tag/解析.md","lastUpdated":1720835436706}'),p={name:"6.源码阅读/vscode-auto-rename-tag/解析.md"},o=l(`<h1 id="源码阅读" tabindex="-1">源码阅读 <a class="header-anchor" href="#源码阅读" aria-hidden="true">#</a></h1><h2 id="插件激活函数activate" tabindex="-1">插件激活函数<code>activate</code> <a class="header-anchor" href="#插件激活函数activate" aria-hidden="true">#</a></h2><h3 id="路径packages-extension-src-extensionmain-ts" tabindex="-1">路径<code>packages/extension/src/extensionMain.ts</code> <a class="header-anchor" href="#路径packages-extension-src-extensionmain-ts" aria-hidden="true">#</a></h3><p><code>activate</code>函数是vscode插件的激活函数，即主函数，必不可少，插件安装激活时进行触发，阅读vscode插件源码一般先看这个函数</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki one-dark-pro vp-code-dark" tabindex="0"><code><span class="line"><span style="color:#C678DD;">export</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">activate</span><span style="color:#ABB2BF;">: (</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#E06C75;font-style:italic;">context</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">vscode</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">ExtensionContext</span></span>
<span class="line"><span style="color:#ABB2BF;">) </span><span style="color:#C678DD;">=&gt;</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">Promise</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">void</span><span style="color:#ABB2BF;">&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">async</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;font-style:italic;">context</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">=&gt;</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#7F848E;font-style:italic;">// 获取插件的\`activationOnLanguage\`属性（插件激活语言）的用户配置值，但是这里并没有赋值给任何变量，应该是作者写错了</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#E5C07B;">vscode</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">workspace</span></span>
<span class="line"><span style="color:#ABB2BF;">    .</span><span style="color:#61AFEF;">getConfiguration</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;auto-rename-tag&#39;</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">    .</span><span style="color:#61AFEF;">get</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;activationOnLanguage&#39;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#7F848E;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">   * 是否需要开启插件</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">   * </span><span style="color:#C678DD;font-style:italic;">@param</span><span style="color:#7F848E;font-style:italic;"> </span><span style="color:#E06C75;font-style:italic;">document</span><span style="color:#7F848E;font-style:italic;"> 接收一个编辑器对象</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">   * </span><span style="color:#C678DD;font-style:italic;">@returns</span><span style="color:#7F848E;font-style:italic;"> 返回一个\`Boolean\`值，表示插件是否需要开启</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">   */</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">isEnabled</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> (</span><span style="color:#E06C75;font-style:italic;">document</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">vscode</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">TextDocument</span><span style="color:#ABB2BF;"> | </span><span style="color:#E5C07B;">undefined</span><span style="color:#ABB2BF;">) </span><span style="color:#C678DD;">=&gt;</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#7F848E;font-style:italic;">// 如果没有编辑器对象，不开启插件</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#E06C75;">document</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">return</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">false</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#7F848E;font-style:italic;">// 获取编辑器对象的语言</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">languageId</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">document</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">languageId</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#7F848E;font-style:italic;">// 如果是\`html\`或者\`handlebars\`语言，就再获取vscode的\`editor\`配置中的\`renameOnType\`和\`linkedEditing\`是否开启，如果开启了这两个属性，就不开启插件了。这两个属性是vscode内置的配置属性，可以实现标签重命名效果，新版本vscode中\`renameOnType\`属性废弃，被\`linkedEditing\`取代了，但这两个属性目前还是没有插件全面，比如\`linkedEditing\`对\`jsx\`的支持还有问题</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (</span><span style="color:#E06C75;">languageId</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">===</span><span style="color:#ABB2BF;"> </span><span style="color:#98C379;">&#39;html&#39;</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">||</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">languageId</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">===</span><span style="color:#ABB2BF;"> </span><span style="color:#98C379;">&#39;handlebars&#39;</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">editorSettings</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">vscode</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">workspace</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getConfiguration</span><span style="color:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#98C379;">&#39;editor&#39;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#E06C75;">document</span></span>
<span class="line"><span style="color:#ABB2BF;">      );</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#E5C07B;">editorSettings</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">get</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;renameOnType&#39;</span><span style="color:#ABB2BF;">) </span><span style="color:#56B6C2;">||</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#E5C07B;">editorSettings</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">get</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;linkedEditing&#39;</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">      ) {</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">return</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">false</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">      }</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#7F848E;font-style:italic;">// 获取插件的当前编辑器对象的配置</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">config</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">vscode</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">workspace</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getConfiguration</span><span style="color:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#98C379;">&#39;auto-rename-tag&#39;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#E5C07B;">document</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">uri</span></span>
<span class="line"><span style="color:#ABB2BF;">    );</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#7F848E;font-style:italic;">// 激活语言配置，如果激活语言配置是\`*\`即\`任何\`，或者编辑器对象的语言包含在激活语言配置数组中，则开启插件</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">languages</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">config</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">get</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">string</span><span style="color:#ABB2BF;">[]&gt;(</span><span style="color:#98C379;">&#39;activationOnLanguage&#39;</span><span style="color:#ABB2BF;">, [</span><span style="color:#98C379;">&#39;*&#39;</span><span style="color:#ABB2BF;">]);</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">return</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">languages</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">includes</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;*&#39;</span><span style="color:#ABB2BF;">) </span><span style="color:#56B6C2;">||</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">languages</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">includes</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">languageId</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">  };</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#7F848E;font-style:italic;">// \`context.subscriptions.push\`添加了一个可被清理的对象到插件的订阅中，\`vscode.workspace.onDidChangeConfiguration\`事件，监听配置更改，配置有所更改时触发，event.affectsConfiguration\`也很好理解，是否影响了指定名称插件的配置，这里写了注释，表示清除\`vscode.workspace.getConfiguration\`的缓存，但是没看出来做了啥，这段代码是多写的嘛？</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#E5C07B;">context</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">subscriptions</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">push</span><span style="color:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#E5C07B;">vscode</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">workspace</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">onDidChangeConfiguration</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;font-style:italic;">event</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">=&gt;</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#7F848E;font-style:italic;">// purges cache for \`vscode.workspace.getConfiguration\`</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#E5C07B;">event</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">affectsConfiguration</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&#39;auto-rename-tag&#39;</span><span style="color:#ABB2BF;">)) {</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">return</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">      }</span></span>
<span class="line"><span style="color:#ABB2BF;">    })</span></span>
<span class="line"><span style="color:#ABB2BF;">  );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#7F848E;font-style:italic;">// 创建与服务器的连</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">clientOptions</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">LanguageClientOptions</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#E06C75;">documentSelector</span><span style="color:#ABB2BF;">: [</span></span>
<span class="line"><span style="color:#ABB2BF;">      {</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#E06C75;">scheme</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&#39;*&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;">      }</span></span>
<span class="line"><span style="color:#ABB2BF;">    ]</span></span>
<span class="line"><span style="color:#ABB2BF;">  };</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">languageClientProxy</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">await</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">createLanguageClientProxy</span><span style="color:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#E06C75;">context</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#98C379;">&#39;auto-rename-tag&#39;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#98C379;">&#39;Auto Rename Tag&#39;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#E06C75;">clientOptions</span></span>
<span class="line"><span style="color:#ABB2BF;">  );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#7F848E;font-style:italic;">// \`context.subscriptions.push\`添加了一个可被清理的对象到插件的订阅中。这个对象包含一个\`dispose\`方法，用于执行资源清理。当插件被禁用或销毁时，VSCode会自动调用这些\`dispose\`方法，从而进行资源的释放。总而言之，\`dispose\`函数是用于释放资源和执行清理操作的一种规范方法，确保在插件不再需要某些资源时，这些资源能够被正确释放。</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">let</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">activeTextEditor</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">vscode</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">TextEditor</span><span style="color:#ABB2BF;"> | </span><span style="color:#E5C07B;">undefined</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#E5C07B;">vscode</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">window</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">activeTextEditor</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">let</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">changeListener</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Disposable</span><span style="color:#ABB2BF;"> | </span><span style="color:#E5C07B;">undefined</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#E5C07B;">context</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">subscriptions</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">push</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#61AFEF;">dispose</span><span style="color:#ABB2BF;">() {</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (</span><span style="color:#E06C75;">changeListener</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#E5C07B;">changeListener</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">dispose</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#E06C75;">changeListener</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">undefined</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">      }</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#ABB2BF;">  });</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">setupChangeListener</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> () </span><span style="color:#C678DD;">=&gt;</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (</span><span style="color:#E06C75;">changeListener</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">return</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#7F848E;font-style:italic;">// 创建一个\`vscode.workspace.onDidChangeTextDocument\`事件，编辑器内容变化会触发该事件</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#E06C75;">changeListener</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">vscode</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">workspace</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">onDidChangeTextDocument</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">async</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;font-style:italic;">event</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">=&gt;</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (</span><span style="color:#E5C07B;">event</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">document</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">!==</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">activeTextEditor</span><span style="color:#ABB2BF;">?.</span><span style="color:#E06C75;">document</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">return</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#61AFEF;">isEnabled</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">event</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">document</span><span style="color:#ABB2BF;">)) {</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#E5C07B;">changeListener</span><span style="color:#ABB2BF;">?.</span><span style="color:#61AFEF;">dispose</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#E06C75;">changeListener</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">undefined</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">return</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#7F848E;font-style:italic;">// event.contentChanges是编辑器的修改内容</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (</span><span style="color:#E5C07B;">event</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">contentChanges</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">length</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">===</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">return</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">      }</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#7F848E;font-style:italic;">// 获取编辑器内的内容</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">currentText</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">event</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">document</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getText</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">tags</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Tag</span><span style="color:#ABB2BF;">[] </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> [];</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">let</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">totalInserted</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#7F848E;font-style:italic;">// slice浅拷贝，根据rangeOffset排好序</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">sortedChanges</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">event</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">contentChanges</span></span>
<span class="line"><span style="color:#ABB2BF;">        .</span><span style="color:#61AFEF;">slice</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#ABB2BF;">        .</span><span style="color:#61AFEF;">sort</span><span style="color:#ABB2BF;">((</span><span style="color:#E06C75;font-style:italic;">a</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;font-style:italic;">b</span><span style="color:#ABB2BF;">) </span><span style="color:#C678DD;">=&gt;</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">a</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">rangeOffset</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">-</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">b</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">rangeOffset</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">keys</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">Object</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">keys</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">wordsAtOffsets</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#7F848E;font-style:italic;">// {</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#7F848E;font-style:italic;">//   oldWord: &quot;&lt;title&quot;,</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#7F848E;font-style:italic;">//   word: &quot;&lt;1&quot;,</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#7F848E;font-style:italic;">//   offset: 389,</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#7F848E;font-style:italic;">//   previousOffset: 389,</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#7F848E;font-style:italic;">// }</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">for</span><span style="color:#ABB2BF;"> (</span><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">change</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">of</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">sortedChanges</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">for</span><span style="color:#ABB2BF;"> (</span><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">key</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">of</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">keys</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">          </span><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">parsedKey</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">parseInt</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">key</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">10</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">          </span><span style="color:#7F848E;font-style:italic;">// 修改</span></span>
<span class="line"><span style="color:#ABB2BF;">          </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (</span></span>
<span class="line"><span style="color:#ABB2BF;">            </span><span style="color:#E5C07B;">change</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">rangeOffset</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">&lt;=</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">parsedKey</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">&amp;&amp;</span></span>
<span class="line"><span style="color:#ABB2BF;">            </span><span style="color:#E06C75;">parsedKey</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">&lt;=</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">change</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">rangeOffset</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">+</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">change</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">rangeLength</span></span>
<span class="line"><span style="color:#ABB2BF;">          ) {</span></span>
<span class="line"><span style="color:#ABB2BF;">            </span><span style="color:#C678DD;">delete</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">wordsAtOffsets</span><span style="color:#ABB2BF;">[</span><span style="color:#E06C75;">key</span><span style="color:#ABB2BF;">];</span></span>
<span class="line"><span style="color:#ABB2BF;">          }</span></span>
<span class="line"><span style="color:#ABB2BF;">        }</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#61AFEF;">assertDefined</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">previousText</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">debugger</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#7F848E;font-style:italic;">// 获取更改开始位置所在行的信息</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">line</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">event</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">document</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">lineAt</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">change</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">range</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">start</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">line</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#7F848E;font-style:italic;">// 获取行开始位置索引</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">lineStart</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">event</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">document</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">offsetAt</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">line</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">range</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">start</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#7F848E;font-style:italic;">// change.rangeOffset 被替换的区域的偏移量</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">lineChangeOffset</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">change</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">rangeOffset</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">-</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">lineStart</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#7F848E;font-style:italic;">// 测试用例: &#39;&lt;1 id=&quot;three-container&quot;&gt;&lt;/div&gt;&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#7F848E;font-style:italic;">// &quot;&lt;&quot;</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">lineLeft</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">line</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">text</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">slice</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">lineChangeOffset</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">+</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">totalInserted</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#7F848E;font-style:italic;">// &#39;1 id=&quot;three-container&quot;&gt;&lt;/div&gt;&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">lineRight</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">line</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">text</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">slice</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">lineChangeOffset</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">+</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">totalInserted</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#7F848E;font-style:italic;">// &quot;&lt;&quot;</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">lineTagNameLeft</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">lineLeft</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">match</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">tagNameReLeft</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#7F848E;font-style:italic;">// &quot;1&quot;</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">lineTagNameRight</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">lineRight</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">match</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">tagNameRERight</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#7F848E;font-style:italic;">// &#39;div id=&quot;three-container&quot;&gt;&lt;/div&gt;\\n\\n&lt;div id=&quot;instructions&quot;&gt;\\n\\tclick and drag to control the animation\\n&lt;/div&gt;\\n&lt;!-- partial --&gt;\\n  &lt;script src=&#39;//cdnjs.cloudflare.com/ajax/libs/three.js/r75/three.min.js&#39;&gt;&lt;/script&gt;\\n&lt;script src=&#39;//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.0/TweenMax.min.js&#39;&gt;&lt;/script&gt;\\n&lt;script src=&#39;https://s3-us-west-2.amazonaws.com/s.cdpn.io/175711/bas.js&#39;&gt;&lt;/script&gt;\\n&lt;script src=&#39;https://s3-us-west-2.amazonaws.com/s.cdpn.io/175711/OrbitControls-2.js&#39;&gt;&lt;/script&gt;&lt;script  src=&quot;./script.js&quot;&gt;&lt;/script&gt;\\n\\n&lt;/body&gt;\\n&lt;/html&gt;\\n&#39;</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">previousTextRight</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">previousText</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">slice</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">change</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">rangeOffset</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#7F848E;font-style:italic;">// div</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">previousTagNameRight</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">previousTextRight</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">match</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">tagNameRERight</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">let</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">newWord</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">string</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">let</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">oldWord</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">string</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#E06C75;">lineTagNameLeft</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">          </span><span style="color:#E06C75;">totalInserted</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">+=</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">change</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">text</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">length</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">-</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">change</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">rangeLength</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">          </span><span style="color:#C678DD;">continue</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">        }</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#7F848E;font-style:italic;">// &quot;&lt;&quot;</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#E06C75;">newWord</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">lineTagNameLeft</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">];</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#E06C75;">oldWord</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">lineTagNameLeft</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">];</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (</span><span style="color:#E06C75;">lineTagNameRight</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">          </span><span style="color:#7F848E;font-style:italic;">// &quot;&lt;1&quot;</span></span>
<span class="line"><span style="color:#ABB2BF;">          </span><span style="color:#E06C75;">newWord</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">+=</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">lineTagNameRight</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">];</span></span>
<span class="line"><span style="color:#ABB2BF;">        }</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (</span><span style="color:#E06C75;">previousTagNameRight</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">          </span><span style="color:#7F848E;font-style:italic;">// &quot;&lt;title&quot;</span></span>
<span class="line"><span style="color:#ABB2BF;">          </span><span style="color:#E06C75;">oldWord</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">+=</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">previousTagNameRight</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">];</span></span>
<span class="line"><span style="color:#ABB2BF;">        }</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">offset</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span></span>
<span class="line"><span style="color:#ABB2BF;">          </span><span style="color:#E5C07B;">change</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">rangeOffset</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">-</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">lineTagNameLeft</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">].</span><span style="color:#E06C75;">length</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">+</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">totalInserted</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#E5C07B;">tags</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">push</span><span style="color:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#ABB2BF;">          </span><span style="color:#E06C75;">oldWord</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">          </span><span style="color:#E06C75;">word</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">newWord</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">          </span><span style="color:#E06C75;">offset</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">          </span><span style="color:#E06C75;">previousOffset</span><span style="color:#ABB2BF;">: </span><span style="color:#E06C75;">offset</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">-</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">totalInserted</span></span>
<span class="line"><span style="color:#ABB2BF;">        });</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#E06C75;">totalInserted</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">+=</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">change</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">text</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">length</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">-</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">change</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">rangeLength</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">      }</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#61AFEF;">updateWordsAtOffset</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">tags</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (</span><span style="color:#E5C07B;">tags</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">length</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">===</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#E06C75;">previousText</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">currentText</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">return</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">      }</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#61AFEF;">assertDefined</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">vscode</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">window</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">activeTextEditor</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#E06C75;">previousText</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">currentText</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#61AFEF;">doAutoCompletionElementRenameTag</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">languageClientProxy</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">tags</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">    });</span></span>
<span class="line"><span style="color:#ABB2BF;">  };</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#61AFEF;">setPreviousText</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">vscode</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">window</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">activeTextEditor</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#61AFEF;">setupChangeListener</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#E5C07B;">context</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">subscriptions</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">push</span><span style="color:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#7F848E;font-style:italic;">// \`vscode.window.onDidChangeActiveTextEditor\`更改聚焦的编辑器触发，触发后重新设置监听器</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#E5C07B;">vscode</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">window</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">onDidChangeActiveTextEditor</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;font-style:italic;">textEditor</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">=&gt;</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#E06C75;">activeTextEditor</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">textEditor</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">doument</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">activeTextEditor</span><span style="color:#ABB2BF;">?.</span><span style="color:#E06C75;">document</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#61AFEF;">isEnabled</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">doument</span><span style="color:#ABB2BF;">)) {</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (</span><span style="color:#E06C75;">changeListener</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">          </span><span style="color:#E5C07B;">changeListener</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">dispose</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#ABB2BF;">          </span><span style="color:#E06C75;">changeListener</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">undefined</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">        }</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">return</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">      }</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#61AFEF;">setPreviousText</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">textEditor</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#61AFEF;">setupChangeListener</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#ABB2BF;">    })</span></span>
<span class="line"><span style="color:#ABB2BF;">  );</span></span>
<span class="line"><span style="color:#ABB2BF;">};</span></span>
<span class="line"></span></code></pre><pre class="shiki min-dark vp-code-light" tabindex="0"><code><span class="line"><span style="color:#F97583;">export</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">const</span><span style="color:#B392F0;"> activate</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> (</span></span>
<span class="line"><span style="color:#B392F0;">  context</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> vscode.ExtensionContext</span></span>
<span class="line"><span style="color:#B392F0;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#B392F0;"> Promise&lt;</span><span style="color:#79B8FF;">void</span><span style="color:#B392F0;">&gt; </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">async</span><span style="color:#B392F0;"> context </span><span style="color:#F97583;">=&gt;</span><span style="color:#B392F0;"> {</span></span>
<span class="line"><span style="color:#B392F0;">  </span><span style="color:#6B737C;">// 获取插件的\`activationOnLanguage\`属性（插件激活语言）的用户配置值，但是这里并没有赋值给任何变量，应该是作者写错了</span></span>
<span class="line"><span style="color:#B392F0;">  </span><span style="color:#79B8FF;">vscode</span><span style="color:#B392F0;">.workspace</span></span>
<span class="line"><span style="color:#B392F0;">    .getConfiguration(</span><span style="color:#FFAB70;">&#39;auto-rename-tag&#39;</span><span style="color:#B392F0;">)</span></span>
<span class="line"><span style="color:#B392F0;">    .get(</span><span style="color:#FFAB70;">&#39;activationOnLanguage&#39;</span><span style="color:#B392F0;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  </span><span style="color:#6B737C;">/**</span></span>
<span class="line"><span style="color:#6B737C;">   * 是否需要开启插件</span></span>
<span class="line"><span style="color:#6B737C;">   * </span><span style="color:#F97583;">@param</span><span style="color:#6B737C;"> document 接收一个编辑器对象</span></span>
<span class="line"><span style="color:#6B737C;">   * </span><span style="color:#F97583;">@returns</span><span style="color:#6B737C;"> 返回一个\`Boolean\`值，表示插件是否需要开启</span></span>
<span class="line"><span style="color:#6B737C;">   */</span></span>
<span class="line"><span style="color:#B392F0;">  </span><span style="color:#F97583;">const</span><span style="color:#B392F0;"> isEnabled </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> (document</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> vscode.TextDocument </span><span style="color:#F97583;">|</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">undefined</span><span style="color:#B392F0;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#B392F0;"> {</span></span>
<span class="line"><span style="color:#B392F0;">    </span><span style="color:#6B737C;">// 如果没有编辑器对象，不开启插件</span></span>
<span class="line"><span style="color:#B392F0;">    </span><span style="color:#F97583;">if</span><span style="color:#B392F0;"> (</span><span style="color:#F97583;">!</span><span style="color:#B392F0;">document) {</span></span>
<span class="line"><span style="color:#B392F0;">      </span><span style="color:#F97583;">return</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">false</span><span style="color:#B392F0;">;</span></span>
<span class="line"><span style="color:#B392F0;">    }</span></span>
<span class="line"><span style="color:#B392F0;">    </span><span style="color:#6B737C;">// 获取编辑器对象的语言</span></span>
<span class="line"><span style="color:#B392F0;">    </span><span style="color:#F97583;">const</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">languageId</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">document</span><span style="color:#B392F0;">.languageId;</span></span>
<span class="line"><span style="color:#B392F0;">    </span><span style="color:#6B737C;">// 如果是\`html\`或者\`handlebars\`语言，就再获取vscode的\`editor\`配置中的\`renameOnType\`和\`linkedEditing\`是否开启，如果开启了这两个属性，就不开启插件了。这两个属性是vscode内置的配置属性，可以实现标签重命名效果，新版本vscode中\`renameOnType\`属性废弃，被\`linkedEditing\`取代了，但这两个属性目前还是没有插件全面，比如\`linkedEditing\`对\`jsx\`的支持还有问题</span></span>
<span class="line"><span style="color:#B392F0;">    </span><span style="color:#F97583;">if</span><span style="color:#B392F0;"> (languageId </span><span style="color:#F97583;">===</span><span style="color:#B392F0;"> </span><span style="color:#FFAB70;">&#39;html&#39;</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">||</span><span style="color:#B392F0;"> languageId </span><span style="color:#F97583;">===</span><span style="color:#B392F0;"> </span><span style="color:#FFAB70;">&#39;handlebars&#39;</span><span style="color:#B392F0;">) {</span></span>
<span class="line"><span style="color:#B392F0;">      </span><span style="color:#F97583;">const</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">editorSettings</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">vscode</span><span style="color:#B392F0;">.</span><span style="color:#79B8FF;">workspace</span><span style="color:#B392F0;">.getConfiguration(</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#FFAB70;">&#39;editor&#39;</span><span style="color:#BBBBBB;">,</span></span>
<span class="line"><span style="color:#B392F0;">        document</span></span>
<span class="line"><span style="color:#B392F0;">      );</span></span>
<span class="line"><span style="color:#B392F0;">      </span><span style="color:#F97583;">if</span><span style="color:#B392F0;"> (</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#79B8FF;">editorSettings</span><span style="color:#B392F0;">.get(</span><span style="color:#FFAB70;">&#39;renameOnType&#39;</span><span style="color:#B392F0;">) </span><span style="color:#F97583;">||</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#79B8FF;">editorSettings</span><span style="color:#B392F0;">.get(</span><span style="color:#FFAB70;">&#39;linkedEditing&#39;</span><span style="color:#B392F0;">)</span></span>
<span class="line"><span style="color:#B392F0;">      ) {</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#F97583;">return</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">false</span><span style="color:#B392F0;">;</span></span>
<span class="line"><span style="color:#B392F0;">      }</span></span>
<span class="line"><span style="color:#B392F0;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">    </span><span style="color:#6B737C;">// 获取插件的当前编辑器对象的配置</span></span>
<span class="line"><span style="color:#B392F0;">    </span><span style="color:#F97583;">const</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">config</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">vscode</span><span style="color:#B392F0;">.</span><span style="color:#79B8FF;">workspace</span><span style="color:#B392F0;">.getConfiguration(</span></span>
<span class="line"><span style="color:#B392F0;">      </span><span style="color:#FFAB70;">&#39;auto-rename-tag&#39;</span><span style="color:#BBBBBB;">,</span></span>
<span class="line"><span style="color:#B392F0;">      </span><span style="color:#79B8FF;">document</span><span style="color:#B392F0;">.uri</span></span>
<span class="line"><span style="color:#B392F0;">    );</span></span>
<span class="line"><span style="color:#B392F0;">    </span><span style="color:#6B737C;">// 激活语言配置，如果激活语言配置是\`*\`即\`任何\`，或者编辑器对象的语言包含在激活语言配置数组中，则开启插件</span></span>
<span class="line"><span style="color:#B392F0;">    </span><span style="color:#F97583;">const</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">languages</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">config</span><span style="color:#B392F0;">.get&lt;</span><span style="color:#79B8FF;">string</span><span style="color:#B392F0;">[]&gt;(</span><span style="color:#FFAB70;">&#39;activationOnLanguage&#39;</span><span style="color:#BBBBBB;">,</span><span style="color:#B392F0;"> [</span><span style="color:#FFAB70;">&#39;*&#39;</span><span style="color:#B392F0;">]);</span></span>
<span class="line"><span style="color:#B392F0;">    </span><span style="color:#F97583;">return</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">languages</span><span style="color:#B392F0;">.includes(</span><span style="color:#FFAB70;">&#39;*&#39;</span><span style="color:#B392F0;">) </span><span style="color:#F97583;">||</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">languages</span><span style="color:#B392F0;">.includes(languageId);</span></span>
<span class="line"><span style="color:#B392F0;">  };</span></span>
<span class="line"><span style="color:#B392F0;">  </span><span style="color:#6B737C;">// \`context.subscriptions.push\`添加了一个可被清理的对象到插件的订阅中，\`vscode.workspace.onDidChangeConfiguration\`事件，监听配置更改，配置有所更改时触发，event.affectsConfiguration\`也很好理解，是否影响了指定名称插件的配置，这里写了注释，表示清除\`vscode.workspace.getConfiguration\`的缓存，但是没看出来做了啥，这段代码是多写的嘛？</span></span>
<span class="line"><span style="color:#B392F0;">  </span><span style="color:#79B8FF;">context</span><span style="color:#B392F0;">.</span><span style="color:#79B8FF;">subscriptions</span><span style="color:#B392F0;">.push(</span></span>
<span class="line"><span style="color:#B392F0;">    </span><span style="color:#79B8FF;">vscode</span><span style="color:#B392F0;">.</span><span style="color:#79B8FF;">workspace</span><span style="color:#B392F0;">.onDidChangeConfiguration(event </span><span style="color:#F97583;">=&gt;</span><span style="color:#B392F0;"> {</span></span>
<span class="line"><span style="color:#B392F0;">      </span><span style="color:#6B737C;">// purges cache for \`vscode.workspace.getConfiguration\`</span></span>
<span class="line"><span style="color:#B392F0;">      </span><span style="color:#F97583;">if</span><span style="color:#B392F0;"> (</span><span style="color:#F97583;">!</span><span style="color:#79B8FF;">event</span><span style="color:#B392F0;">.affectsConfiguration(</span><span style="color:#FFAB70;">&#39;auto-rename-tag&#39;</span><span style="color:#B392F0;">)) {</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#F97583;">return</span><span style="color:#B392F0;">;</span></span>
<span class="line"><span style="color:#B392F0;">      }</span></span>
<span class="line"><span style="color:#B392F0;">    })</span></span>
<span class="line"><span style="color:#B392F0;">  );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  </span><span style="color:#6B737C;">// 创建与服务器的连</span></span>
<span class="line"><span style="color:#B392F0;">  </span><span style="color:#F97583;">const</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">clientOptions</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> LanguageClientOptions </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> {</span></span>
<span class="line"><span style="color:#B392F0;">    documentSelector</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> [</span></span>
<span class="line"><span style="color:#B392F0;">      {</span></span>
<span class="line"><span style="color:#B392F0;">        scheme</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> </span><span style="color:#FFAB70;">&#39;*&#39;</span></span>
<span class="line"><span style="color:#B392F0;">      }</span></span>
<span class="line"><span style="color:#B392F0;">    ]</span></span>
<span class="line"><span style="color:#B392F0;">  };</span></span>
<span class="line"><span style="color:#B392F0;">  </span><span style="color:#F97583;">const</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">languageClientProxy</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">await</span><span style="color:#B392F0;"> createLanguageClientProxy(</span></span>
<span class="line"><span style="color:#B392F0;">    context</span><span style="color:#BBBBBB;">,</span></span>
<span class="line"><span style="color:#B392F0;">    </span><span style="color:#FFAB70;">&#39;auto-rename-tag&#39;</span><span style="color:#BBBBBB;">,</span></span>
<span class="line"><span style="color:#B392F0;">    </span><span style="color:#FFAB70;">&#39;Auto Rename Tag&#39;</span><span style="color:#BBBBBB;">,</span></span>
<span class="line"><span style="color:#B392F0;">    clientOptions</span></span>
<span class="line"><span style="color:#B392F0;">  );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  </span><span style="color:#6B737C;">// \`context.subscriptions.push\`添加了一个可被清理的对象到插件的订阅中。这个对象包含一个\`dispose\`方法，用于执行资源清理。当插件被禁用或销毁时，VSCode会自动调用这些\`dispose\`方法，从而进行资源的释放。总而言之，\`dispose\`函数是用于释放资源和执行清理操作的一种规范方法，确保在插件不再需要某些资源时，这些资源能够被正确释放。</span></span>
<span class="line"><span style="color:#B392F0;">  </span><span style="color:#F97583;">let</span><span style="color:#B392F0;"> activeTextEditor</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> vscode.TextEditor </span><span style="color:#F97583;">|</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">undefined</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">=</span></span>
<span class="line"><span style="color:#B392F0;">    </span><span style="color:#79B8FF;">vscode</span><span style="color:#B392F0;">.</span><span style="color:#79B8FF;">window</span><span style="color:#B392F0;">.activeTextEditor;</span></span>
<span class="line"><span style="color:#B392F0;">  </span><span style="color:#F97583;">let</span><span style="color:#B392F0;"> changeListener</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> Disposable </span><span style="color:#F97583;">|</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">undefined</span><span style="color:#B392F0;">;</span></span>
<span class="line"><span style="color:#B392F0;">  </span><span style="color:#79B8FF;">context</span><span style="color:#B392F0;">.</span><span style="color:#79B8FF;">subscriptions</span><span style="color:#B392F0;">.push({</span></span>
<span class="line"><span style="color:#B392F0;">    dispose() {</span></span>
<span class="line"><span style="color:#B392F0;">      </span><span style="color:#F97583;">if</span><span style="color:#B392F0;"> (changeListener) {</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#79B8FF;">changeListener</span><span style="color:#B392F0;">.dispose();</span></span>
<span class="line"><span style="color:#B392F0;">        changeListener </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">undefined</span><span style="color:#B392F0;">;</span></span>
<span class="line"><span style="color:#B392F0;">      }</span></span>
<span class="line"><span style="color:#B392F0;">    }</span></span>
<span class="line"><span style="color:#B392F0;">  });</span></span>
<span class="line"><span style="color:#B392F0;">  </span><span style="color:#F97583;">const</span><span style="color:#B392F0;"> setupChangeListener </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> () </span><span style="color:#F97583;">=&gt;</span><span style="color:#B392F0;"> {</span></span>
<span class="line"><span style="color:#B392F0;">    </span><span style="color:#F97583;">if</span><span style="color:#B392F0;"> (changeListener) {</span></span>
<span class="line"><span style="color:#B392F0;">      </span><span style="color:#F97583;">return</span><span style="color:#B392F0;">;</span></span>
<span class="line"><span style="color:#B392F0;">    }</span></span>
<span class="line"><span style="color:#B392F0;">    </span><span style="color:#6B737C;">// 创建一个\`vscode.workspace.onDidChangeTextDocument\`事件，编辑器内容变化会触发该事件</span></span>
<span class="line"><span style="color:#B392F0;">    changeListener </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">vscode</span><span style="color:#B392F0;">.</span><span style="color:#79B8FF;">workspace</span><span style="color:#B392F0;">.onDidChangeTextDocument(</span><span style="color:#F97583;">async</span><span style="color:#B392F0;"> event </span><span style="color:#F97583;">=&gt;</span><span style="color:#B392F0;"> {</span></span>
<span class="line"><span style="color:#B392F0;">      </span><span style="color:#F97583;">if</span><span style="color:#B392F0;"> (</span><span style="color:#79B8FF;">event</span><span style="color:#B392F0;">.document </span><span style="color:#F97583;">!==</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">activeTextEditor</span><span style="color:#B392F0;">?.document) {</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#F97583;">return</span><span style="color:#B392F0;">;</span></span>
<span class="line"><span style="color:#B392F0;">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">      </span><span style="color:#F97583;">if</span><span style="color:#B392F0;"> (</span><span style="color:#F97583;">!</span><span style="color:#B392F0;">isEnabled(</span><span style="color:#79B8FF;">event</span><span style="color:#B392F0;">.document)) {</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#79B8FF;">changeListener</span><span style="color:#B392F0;">?.dispose();</span></span>
<span class="line"><span style="color:#B392F0;">        changeListener </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">undefined</span><span style="color:#B392F0;">;</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#F97583;">return</span><span style="color:#B392F0;">;</span></span>
<span class="line"><span style="color:#B392F0;">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">      </span><span style="color:#6B737C;">// event.contentChanges是编辑器的修改内容</span></span>
<span class="line"><span style="color:#B392F0;">      </span><span style="color:#F97583;">if</span><span style="color:#B392F0;"> (</span><span style="color:#79B8FF;">event</span><span style="color:#B392F0;">.</span><span style="color:#79B8FF;">contentChanges</span><span style="color:#B392F0;">.</span><span style="color:#79B8FF;">length</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">===</span><span style="color:#B392F0;"> </span><span style="color:#F8F8F8;">0</span><span style="color:#B392F0;">) {</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#F97583;">return</span><span style="color:#B392F0;">;</span></span>
<span class="line"><span style="color:#B392F0;">      }</span></span>
<span class="line"><span style="color:#B392F0;">      </span><span style="color:#6B737C;">// 获取编辑器内的内容</span></span>
<span class="line"><span style="color:#B392F0;">      </span><span style="color:#F97583;">const</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">currentText</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">event</span><span style="color:#B392F0;">.</span><span style="color:#79B8FF;">document</span><span style="color:#B392F0;">.getText();</span></span>
<span class="line"><span style="color:#B392F0;">      </span><span style="color:#F97583;">const</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">tags</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> Tag[] </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> [];</span></span>
<span class="line"><span style="color:#B392F0;">      </span><span style="color:#F97583;">let</span><span style="color:#B392F0;"> totalInserted </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> </span><span style="color:#F8F8F8;">0</span><span style="color:#B392F0;">;</span></span>
<span class="line"><span style="color:#B392F0;">      </span><span style="color:#6B737C;">// slice浅拷贝，根据rangeOffset排好序</span></span>
<span class="line"><span style="color:#B392F0;">      </span><span style="color:#F97583;">const</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">sortedChanges</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">event</span><span style="color:#B392F0;">.contentChanges</span></span>
<span class="line"><span style="color:#B392F0;">        .slice()</span></span>
<span class="line"><span style="color:#B392F0;">        .sort((a</span><span style="color:#BBBBBB;">,</span><span style="color:#B392F0;"> b) </span><span style="color:#F97583;">=&gt;</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">a</span><span style="color:#B392F0;">.rangeOffset </span><span style="color:#F97583;">-</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">b</span><span style="color:#B392F0;">.rangeOffset);</span></span>
<span class="line"><span style="color:#B392F0;">      </span><span style="color:#F97583;">const</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">keys</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">Object</span><span style="color:#B392F0;">.keys(wordsAtOffsets);</span></span>
<span class="line"><span style="color:#B392F0;">      </span><span style="color:#6B737C;">// {</span></span>
<span class="line"><span style="color:#B392F0;">      </span><span style="color:#6B737C;">//   oldWord: &quot;&lt;title&quot;,</span></span>
<span class="line"><span style="color:#B392F0;">      </span><span style="color:#6B737C;">//   word: &quot;&lt;1&quot;,</span></span>
<span class="line"><span style="color:#B392F0;">      </span><span style="color:#6B737C;">//   offset: 389,</span></span>
<span class="line"><span style="color:#B392F0;">      </span><span style="color:#6B737C;">//   previousOffset: 389,</span></span>
<span class="line"><span style="color:#B392F0;">      </span><span style="color:#6B737C;">// }</span></span>
<span class="line"><span style="color:#B392F0;">      </span><span style="color:#F97583;">for</span><span style="color:#B392F0;"> (</span><span style="color:#F97583;">const</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">change</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">of</span><span style="color:#B392F0;"> sortedChanges) {</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#F97583;">for</span><span style="color:#B392F0;"> (</span><span style="color:#F97583;">const</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">key</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">of</span><span style="color:#B392F0;"> keys) {</span></span>
<span class="line"><span style="color:#B392F0;">          </span><span style="color:#F97583;">const</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">parsedKey</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> parseInt(key</span><span style="color:#BBBBBB;">,</span><span style="color:#B392F0;"> </span><span style="color:#F8F8F8;">10</span><span style="color:#B392F0;">);</span></span>
<span class="line"><span style="color:#B392F0;">          </span><span style="color:#6B737C;">// 修改</span></span>
<span class="line"><span style="color:#B392F0;">          </span><span style="color:#F97583;">if</span><span style="color:#B392F0;"> (</span></span>
<span class="line"><span style="color:#B392F0;">            </span><span style="color:#79B8FF;">change</span><span style="color:#B392F0;">.rangeOffset </span><span style="color:#F97583;">&lt;=</span><span style="color:#B392F0;"> parsedKey </span><span style="color:#F97583;">&amp;&amp;</span></span>
<span class="line"><span style="color:#B392F0;">            parsedKey </span><span style="color:#F97583;">&lt;=</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">change</span><span style="color:#B392F0;">.rangeOffset </span><span style="color:#F97583;">+</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">change</span><span style="color:#B392F0;">.rangeLength</span></span>
<span class="line"><span style="color:#B392F0;">          ) {</span></span>
<span class="line"><span style="color:#B392F0;">            </span><span style="color:#F97583;">delete</span><span style="color:#B392F0;"> wordsAtOffsets[key];</span></span>
<span class="line"><span style="color:#B392F0;">          }</span></span>
<span class="line"><span style="color:#B392F0;">        }</span></span>
<span class="line"><span style="color:#B392F0;">        assertDefined(previousText);</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#F97583;">debugger</span><span style="color:#B392F0;">;</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#6B737C;">// 获取更改开始位置所在行的信息</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#F97583;">const</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">line</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">event</span><span style="color:#B392F0;">.</span><span style="color:#79B8FF;">document</span><span style="color:#B392F0;">.lineAt(</span><span style="color:#79B8FF;">change</span><span style="color:#B392F0;">.</span><span style="color:#79B8FF;">range</span><span style="color:#B392F0;">.</span><span style="color:#79B8FF;">start</span><span style="color:#B392F0;">.line);</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#6B737C;">// 获取行开始位置索引</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#F97583;">const</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">lineStart</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">event</span><span style="color:#B392F0;">.</span><span style="color:#79B8FF;">document</span><span style="color:#B392F0;">.offsetAt(</span><span style="color:#79B8FF;">line</span><span style="color:#B392F0;">.</span><span style="color:#79B8FF;">range</span><span style="color:#B392F0;">.start);</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#6B737C;">// change.rangeOffset 被替换的区域的偏移量</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#F97583;">const</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">lineChangeOffset</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">change</span><span style="color:#B392F0;">.rangeOffset </span><span style="color:#F97583;">-</span><span style="color:#B392F0;"> lineStart;</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#6B737C;">// 测试用例: &#39;&lt;1 id=&quot;three-container&quot;&gt;&lt;/div&gt;&#39;</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#6B737C;">// &quot;&lt;&quot;</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#F97583;">const</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">lineLeft</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">line</span><span style="color:#B392F0;">.</span><span style="color:#79B8FF;">text</span><span style="color:#B392F0;">.slice(</span><span style="color:#F8F8F8;">0</span><span style="color:#BBBBBB;">,</span><span style="color:#B392F0;"> lineChangeOffset </span><span style="color:#F97583;">+</span><span style="color:#B392F0;"> totalInserted);</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#6B737C;">// &#39;1 id=&quot;three-container&quot;&gt;&lt;/div&gt;&#39;</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#F97583;">const</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">lineRight</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">line</span><span style="color:#B392F0;">.</span><span style="color:#79B8FF;">text</span><span style="color:#B392F0;">.slice(lineChangeOffset </span><span style="color:#F97583;">+</span><span style="color:#B392F0;"> totalInserted);</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#6B737C;">// &quot;&lt;&quot;</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#F97583;">const</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">lineTagNameLeft</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">lineLeft</span><span style="color:#B392F0;">.match(tagNameReLeft);</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#6B737C;">// &quot;1&quot;</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#F97583;">const</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">lineTagNameRight</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">lineRight</span><span style="color:#B392F0;">.match(tagNameRERight);</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#6B737C;">// &#39;div id=&quot;three-container&quot;&gt;&lt;/div&gt;\\n\\n&lt;div id=&quot;instructions&quot;&gt;\\n\\tclick and drag to control the animation\\n&lt;/div&gt;\\n&lt;!-- partial --&gt;\\n  &lt;script src=&#39;//cdnjs.cloudflare.com/ajax/libs/three.js/r75/three.min.js&#39;&gt;&lt;/script&gt;\\n&lt;script src=&#39;//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.0/TweenMax.min.js&#39;&gt;&lt;/script&gt;\\n&lt;script src=&#39;https://s3-us-west-2.amazonaws.com/s.cdpn.io/175711/bas.js&#39;&gt;&lt;/script&gt;\\n&lt;script src=&#39;https://s3-us-west-2.amazonaws.com/s.cdpn.io/175711/OrbitControls-2.js&#39;&gt;&lt;/script&gt;&lt;script  src=&quot;./script.js&quot;&gt;&lt;/script&gt;\\n\\n&lt;/body&gt;\\n&lt;/html&gt;\\n&#39;</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#F97583;">const</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">previousTextRight</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">previousText</span><span style="color:#B392F0;">.slice(</span><span style="color:#79B8FF;">change</span><span style="color:#B392F0;">.rangeOffset);</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#6B737C;">// div</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#F97583;">const</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">previousTagNameRight</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">previousTextRight</span><span style="color:#B392F0;">.match(tagNameRERight);</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#F97583;">let</span><span style="color:#B392F0;"> newWord</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">string</span><span style="color:#B392F0;">;</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#F97583;">let</span><span style="color:#B392F0;"> oldWord</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">string</span><span style="color:#B392F0;">;</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#F97583;">if</span><span style="color:#B392F0;"> (</span><span style="color:#F97583;">!</span><span style="color:#B392F0;">lineTagNameLeft) {</span></span>
<span class="line"><span style="color:#B392F0;">          totalInserted </span><span style="color:#F97583;">+=</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">change</span><span style="color:#B392F0;">.</span><span style="color:#79B8FF;">text</span><span style="color:#B392F0;">.</span><span style="color:#79B8FF;">length</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">-</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">change</span><span style="color:#B392F0;">.rangeLength;</span></span>
<span class="line"><span style="color:#B392F0;">          </span><span style="color:#F97583;">continue</span><span style="color:#B392F0;">;</span></span>
<span class="line"><span style="color:#B392F0;">        }</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#6B737C;">// &quot;&lt;&quot;</span></span>
<span class="line"><span style="color:#B392F0;">        newWord </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> lineTagNameLeft[</span><span style="color:#F8F8F8;">0</span><span style="color:#B392F0;">];</span></span>
<span class="line"><span style="color:#B392F0;">        oldWord </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> lineTagNameLeft[</span><span style="color:#F8F8F8;">0</span><span style="color:#B392F0;">];</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#F97583;">if</span><span style="color:#B392F0;"> (lineTagNameRight) {</span></span>
<span class="line"><span style="color:#B392F0;">          </span><span style="color:#6B737C;">// &quot;&lt;1&quot;</span></span>
<span class="line"><span style="color:#B392F0;">          newWord </span><span style="color:#F97583;">+=</span><span style="color:#B392F0;"> lineTagNameRight[</span><span style="color:#F8F8F8;">0</span><span style="color:#B392F0;">];</span></span>
<span class="line"><span style="color:#B392F0;">        }</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#F97583;">if</span><span style="color:#B392F0;"> (previousTagNameRight) {</span></span>
<span class="line"><span style="color:#B392F0;">          </span><span style="color:#6B737C;">// &quot;&lt;title&quot;</span></span>
<span class="line"><span style="color:#B392F0;">          oldWord </span><span style="color:#F97583;">+=</span><span style="color:#B392F0;"> previousTagNameRight[</span><span style="color:#F8F8F8;">0</span><span style="color:#B392F0;">];</span></span>
<span class="line"><span style="color:#B392F0;">        }</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#F97583;">const</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">offset</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">=</span></span>
<span class="line"><span style="color:#B392F0;">          </span><span style="color:#79B8FF;">change</span><span style="color:#B392F0;">.rangeOffset </span><span style="color:#F97583;">-</span><span style="color:#B392F0;"> lineTagNameLeft[</span><span style="color:#F8F8F8;">0</span><span style="color:#B392F0;">].</span><span style="color:#79B8FF;">length</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">+</span><span style="color:#B392F0;"> totalInserted;</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#79B8FF;">tags</span><span style="color:#B392F0;">.push({</span></span>
<span class="line"><span style="color:#B392F0;">          oldWord</span><span style="color:#BBBBBB;">,</span></span>
<span class="line"><span style="color:#B392F0;">          word</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> newWord</span><span style="color:#BBBBBB;">,</span></span>
<span class="line"><span style="color:#B392F0;">          offset</span><span style="color:#BBBBBB;">,</span></span>
<span class="line"><span style="color:#B392F0;">          previousOffset</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> offset </span><span style="color:#F97583;">-</span><span style="color:#B392F0;"> totalInserted</span></span>
<span class="line"><span style="color:#B392F0;">        });</span></span>
<span class="line"><span style="color:#B392F0;">        totalInserted </span><span style="color:#F97583;">+=</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">change</span><span style="color:#B392F0;">.</span><span style="color:#79B8FF;">text</span><span style="color:#B392F0;">.</span><span style="color:#79B8FF;">length</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">-</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">change</span><span style="color:#B392F0;">.rangeLength;</span></span>
<span class="line"><span style="color:#B392F0;">      }</span></span>
<span class="line"><span style="color:#B392F0;">      updateWordsAtOffset(tags);</span></span>
<span class="line"><span style="color:#B392F0;">      </span><span style="color:#F97583;">if</span><span style="color:#B392F0;"> (</span><span style="color:#79B8FF;">tags</span><span style="color:#B392F0;">.</span><span style="color:#79B8FF;">length</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">===</span><span style="color:#B392F0;"> </span><span style="color:#F8F8F8;">0</span><span style="color:#B392F0;">) {</span></span>
<span class="line"><span style="color:#B392F0;">        previousText </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> currentText;</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#F97583;">return</span><span style="color:#B392F0;">;</span></span>
<span class="line"><span style="color:#B392F0;">      }</span></span>
<span class="line"><span style="color:#B392F0;">      assertDefined(</span><span style="color:#79B8FF;">vscode</span><span style="color:#B392F0;">.</span><span style="color:#79B8FF;">window</span><span style="color:#B392F0;">.activeTextEditor);</span></span>
<span class="line"><span style="color:#B392F0;">      previousText </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> currentText;</span></span>
<span class="line"><span style="color:#B392F0;">      doAutoCompletionElementRenameTag(languageClientProxy</span><span style="color:#BBBBBB;">,</span><span style="color:#B392F0;"> tags);</span></span>
<span class="line"><span style="color:#B392F0;">    });</span></span>
<span class="line"><span style="color:#B392F0;">  };</span></span>
<span class="line"><span style="color:#B392F0;">  setPreviousText(</span><span style="color:#79B8FF;">vscode</span><span style="color:#B392F0;">.</span><span style="color:#79B8FF;">window</span><span style="color:#B392F0;">.activeTextEditor);</span></span>
<span class="line"><span style="color:#B392F0;">  setupChangeListener();</span></span>
<span class="line"><span style="color:#B392F0;">  </span><span style="color:#79B8FF;">context</span><span style="color:#B392F0;">.</span><span style="color:#79B8FF;">subscriptions</span><span style="color:#B392F0;">.push(</span></span>
<span class="line"><span style="color:#B392F0;">    </span><span style="color:#6B737C;">// \`vscode.window.onDidChangeActiveTextEditor\`更改聚焦的编辑器触发，触发后重新设置监听器</span></span>
<span class="line"><span style="color:#B392F0;">    </span><span style="color:#79B8FF;">vscode</span><span style="color:#B392F0;">.</span><span style="color:#79B8FF;">window</span><span style="color:#B392F0;">.onDidChangeActiveTextEditor(textEditor </span><span style="color:#F97583;">=&gt;</span><span style="color:#B392F0;"> {</span></span>
<span class="line"><span style="color:#B392F0;">      activeTextEditor </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> textEditor;</span></span>
<span class="line"><span style="color:#B392F0;">      </span><span style="color:#F97583;">const</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">doument</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">activeTextEditor</span><span style="color:#B392F0;">?.document;</span></span>
<span class="line"><span style="color:#B392F0;">      </span><span style="color:#F97583;">if</span><span style="color:#B392F0;"> (</span><span style="color:#F97583;">!</span><span style="color:#B392F0;">isEnabled(doument)) {</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#F97583;">if</span><span style="color:#B392F0;"> (changeListener) {</span></span>
<span class="line"><span style="color:#B392F0;">          </span><span style="color:#79B8FF;">changeListener</span><span style="color:#B392F0;">.dispose();</span></span>
<span class="line"><span style="color:#B392F0;">          changeListener </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">undefined</span><span style="color:#B392F0;">;</span></span>
<span class="line"><span style="color:#B392F0;">        }</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#F97583;">return</span><span style="color:#B392F0;">;</span></span>
<span class="line"><span style="color:#B392F0;">      }</span></span>
<span class="line"><span style="color:#B392F0;">      setPreviousText(textEditor);</span></span>
<span class="line"><span style="color:#B392F0;">      setupChangeListener();</span></span>
<span class="line"><span style="color:#B392F0;">    })</span></span>
<span class="line"><span style="color:#B392F0;">  );</span></span>
<span class="line"><span style="color:#B392F0;">};</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br></div></div><h2 id="setupchangelistener函数解析" tabindex="-1">setupChangeListener函数解析 <a class="header-anchor" href="#setupchangelistener函数解析" aria-hidden="true">#</a></h2><p>对<code>onDidChangeTextDocument</code>返回的结果进行了处理，处理成自己需要的格式</p><p>请求服务器来处理标签，返回处理结果</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki one-dark-pro vp-code-dark" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">results</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">await</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">askServerForAutoCompletionsElementRenameTag</span><span style="color:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#E06C75;">languageClientProxy</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#E5C07B;">vscode</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">window</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">activeTextEditor</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">document</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#E06C75;">tags</span></span>
<span class="line"><span style="color:#ABB2BF;">  );</span></span>
<span class="line"></span></code></pre><pre class="shiki min-dark vp-code-light" tabindex="0"><code><span class="line"><span style="color:#B392F0;">  </span><span style="color:#F97583;">const</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">results</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">await</span><span style="color:#B392F0;"> askServerForAutoCompletionsElementRenameTag(</span></span>
<span class="line"><span style="color:#B392F0;">    languageClientProxy</span><span style="color:#BBBBBB;">,</span></span>
<span class="line"><span style="color:#B392F0;">    </span><span style="color:#79B8FF;">vscode</span><span style="color:#B392F0;">.</span><span style="color:#79B8FF;">window</span><span style="color:#B392F0;">.</span><span style="color:#79B8FF;">activeTextEditor</span><span style="color:#B392F0;">.document</span><span style="color:#BBBBBB;">,</span></span>
<span class="line"><span style="color:#B392F0;">    tags</span></span>
<span class="line"><span style="color:#B392F0;">  );</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="根据处理结果修改编辑器内容" tabindex="-1">根据处理结果修改编辑器内容 <a class="header-anchor" href="#根据处理结果修改编辑器内容" aria-hidden="true">#</a></h4><p><code>vscode.window.activeTextEditor.edit</code>api用于修改编辑器内容</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki one-dark-pro vp-code-dark" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">applied</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">await</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">vscode</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">window</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">activeTextEditor</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">edit</span><span style="color:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#E06C75;font-style:italic;">editBuilder</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">=&gt;</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#61AFEF;">assertDefined</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">vscode</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">window</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">activeTextEditor</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">for</span><span style="color:#ABB2BF;"> (</span><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">result</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">of</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">results</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">startPosition</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span></span>
<span class="line"><span style="color:#ABB2BF;">          </span><span style="color:#E5C07B;">vscode</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">window</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">activeTextEditor</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">document</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">positionAt</span><span style="color:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#ABB2BF;">            </span><span style="color:#E5C07B;">result</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">startOffset</span></span>
<span class="line"><span style="color:#ABB2BF;">          );</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">endPosition</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">vscode</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">window</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">activeTextEditor</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">document</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">positionAt</span><span style="color:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#ABB2BF;">          </span><span style="color:#E5C07B;">result</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">endOffset</span></span>
<span class="line"><span style="color:#ABB2BF;">        );</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">range</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">new</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">vscode</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">Range</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">startPosition</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">endPosition</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#E5C07B;">editBuilder</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">replace</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">range</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">result</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">tagName</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">      }</span></span>
<span class="line"><span style="color:#ABB2BF;">    },</span></span>
<span class="line"><span style="color:#ABB2BF;">    {</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#E06C75;">undoStopBefore</span><span style="color:#ABB2BF;">: </span><span style="color:#D19A66;">false</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#E06C75;">undoStopAfter</span><span style="color:#ABB2BF;">: </span><span style="color:#D19A66;">false</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#ABB2BF;">  );</span></span>
<span class="line"></span></code></pre><pre class="shiki min-dark vp-code-light" tabindex="0"><code><span class="line"><span style="color:#B392F0;">  </span><span style="color:#F97583;">const</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">applied</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">await</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">vscode</span><span style="color:#B392F0;">.</span><span style="color:#79B8FF;">window</span><span style="color:#B392F0;">.</span><span style="color:#79B8FF;">activeTextEditor</span><span style="color:#B392F0;">.edit(</span></span>
<span class="line"><span style="color:#B392F0;">    editBuilder </span><span style="color:#F97583;">=&gt;</span><span style="color:#B392F0;"> {</span></span>
<span class="line"><span style="color:#B392F0;">      assertDefined(</span><span style="color:#79B8FF;">vscode</span><span style="color:#B392F0;">.</span><span style="color:#79B8FF;">window</span><span style="color:#B392F0;">.activeTextEditor);</span></span>
<span class="line"><span style="color:#B392F0;">      </span><span style="color:#F97583;">for</span><span style="color:#B392F0;"> (</span><span style="color:#F97583;">const</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">result</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">of</span><span style="color:#B392F0;"> results) {</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#F97583;">const</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">startPosition</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">=</span></span>
<span class="line"><span style="color:#B392F0;">          </span><span style="color:#79B8FF;">vscode</span><span style="color:#B392F0;">.</span><span style="color:#79B8FF;">window</span><span style="color:#B392F0;">.</span><span style="color:#79B8FF;">activeTextEditor</span><span style="color:#B392F0;">.</span><span style="color:#79B8FF;">document</span><span style="color:#B392F0;">.positionAt(</span></span>
<span class="line"><span style="color:#B392F0;">            </span><span style="color:#79B8FF;">result</span><span style="color:#B392F0;">.startOffset</span></span>
<span class="line"><span style="color:#B392F0;">          );</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#F97583;">const</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">endPosition</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">vscode</span><span style="color:#B392F0;">.</span><span style="color:#79B8FF;">window</span><span style="color:#B392F0;">.</span><span style="color:#79B8FF;">activeTextEditor</span><span style="color:#B392F0;">.</span><span style="color:#79B8FF;">document</span><span style="color:#B392F0;">.positionAt(</span></span>
<span class="line"><span style="color:#B392F0;">          </span><span style="color:#79B8FF;">result</span><span style="color:#B392F0;">.endOffset</span></span>
<span class="line"><span style="color:#B392F0;">        );</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#F97583;">const</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">range</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">new</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">vscode</span><span style="color:#B392F0;">.Range(startPosition</span><span style="color:#BBBBBB;">,</span><span style="color:#B392F0;"> endPosition);</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#79B8FF;">editBuilder</span><span style="color:#B392F0;">.replace(range</span><span style="color:#BBBBBB;">,</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">result</span><span style="color:#B392F0;">.tagName);</span></span>
<span class="line"><span style="color:#B392F0;">      }</span></span>
<span class="line"><span style="color:#B392F0;">    }</span><span style="color:#BBBBBB;">,</span></span>
<span class="line"><span style="color:#B392F0;">    {</span></span>
<span class="line"><span style="color:#B392F0;">      undoStopBefore</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">false</span><span style="color:#BBBBBB;">,</span></span>
<span class="line"><span style="color:#B392F0;">      undoStopAfter</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">false</span></span>
<span class="line"><span style="color:#B392F0;">    }</span></span>
<span class="line"><span style="color:#B392F0;">  );</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h2 id="wordsatoffsets有啥用" tabindex="-1">wordsAtOffsets有啥用 <a class="header-anchor" href="#wordsatoffsets有啥用" aria-hidden="true">#</a></h2><p><code>wordsAtOffsets</code> 是一个对象，用于存储标签的信息。它以标签在文档中的偏移量（offset）作为键，记录了每个标签的旧名称（oldWord）和新名称（newWord）。在代码的执行过程中，<code>wordsAtOffsets</code> 用于跟踪标签的名称变化。</p><p>具体用途如下：</p><ol><li>在 <code>updateWordsAtOffset</code> 函数中，当收到标签信息时，会更新 <code>wordsAtOffsets</code> 对象。它会检查标签列表中的每个标签，并根据偏移量来更新或添加标签信息。这样做是为了在接下来的操作中，可以根据标签的偏移量快速找到对应的旧名称。</li><li>在 <code>doAutoCompletionElementRenameTag</code> 函数中，根据之前记录的标签信息和当前的文本内容，会计算需要自动重命名的标签，并将相关信息发送给语言服务器。这个过程中，<code>wordsAtOffsets</code> 可以帮助确定每个标签的旧名称。</li><li>在 <code>applyResults</code> 函数中，通过 <code>wordsAtOffsets</code> 对象，可以将自动重命名的结果应用到活动文本编辑器中，将旧的标签名称替换为新的标签名称。</li></ol><p>总之，<code>wordsAtOffsets</code> 是一个辅助数据结构，用于记录标签的名称信息，并在标签自动重命名的过程中帮助进行相关操作。</p><h2 id="请求服务器自动完成标签重命名的结果" tabindex="-1">请求服务器自动完成标签重命名的结果 <a class="header-anchor" href="#请求服务器自动完成标签重命名的结果" aria-hidden="true">#</a></h2><p>请求服务器自动完成标签重命名的结果</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki one-dark-pro vp-code-dark" tabindex="0"><code><span class="line"><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">askServerForAutoCompletionsElementRenameTag</span><span style="color:#ABB2BF;">: (</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#E06C75;font-style:italic;">languageClientProxy</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">LanguageClientProxy</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#E06C75;font-style:italic;">document</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">vscode</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">TextDocument</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#E06C75;font-style:italic;">tags</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Tag</span><span style="color:#ABB2BF;">[]</span></span>
<span class="line"><span style="color:#ABB2BF;">) </span><span style="color:#C678DD;">=&gt;</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">Promise</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">Result</span><span style="color:#ABB2BF;">[]&gt; </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">async</span><span style="color:#ABB2BF;"> (</span><span style="color:#E06C75;font-style:italic;">languageClientProxy</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;font-style:italic;">document</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;font-style:italic;">tags</span><span style="color:#ABB2BF;">) </span><span style="color:#C678DD;">=&gt;</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">params</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Params</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#E06C75;">textDocument</span><span style="color:#ABB2BF;">:</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#E5C07B;">languageClientProxy</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">code2ProtocolConverter</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">asVersionedTextDocumentIdentifier</span><span style="color:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#E06C75;">document</span></span>
<span class="line"><span style="color:#ABB2BF;">      ),</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#E06C75;">tags</span></span>
<span class="line"><span style="color:#ABB2BF;">  };</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">return</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">languageClientProxy</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">sendRequest</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">autoRenameTagRequestType</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">params</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">};</span></span>
<span class="line"></span></code></pre><pre class="shiki min-dark vp-code-light" tabindex="0"><code><span class="line"><span style="color:#F97583;">const</span><span style="color:#B392F0;"> askServerForAutoCompletionsElementRenameTag</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> (</span></span>
<span class="line"><span style="color:#B392F0;">  languageClientProxy</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> LanguageClientProxy</span><span style="color:#BBBBBB;">,</span></span>
<span class="line"><span style="color:#B392F0;">  document</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> vscode.TextDocument</span><span style="color:#BBBBBB;">,</span></span>
<span class="line"><span style="color:#B392F0;">  tags</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> Tag[]</span></span>
<span class="line"><span style="color:#B392F0;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#B392F0;"> Promise&lt;Result[]&gt; </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">async</span><span style="color:#B392F0;"> (languageClientProxy</span><span style="color:#BBBBBB;">,</span><span style="color:#B392F0;"> document</span><span style="color:#BBBBBB;">,</span><span style="color:#B392F0;"> tags) </span><span style="color:#F97583;">=&gt;</span><span style="color:#B392F0;"> {</span></span>
<span class="line"><span style="color:#B392F0;">  </span><span style="color:#F97583;">const</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">params</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> Params </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> {</span></span>
<span class="line"><span style="color:#B392F0;">    textDocument</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#B392F0;">      </span><span style="color:#79B8FF;">languageClientProxy</span><span style="color:#B392F0;">.</span><span style="color:#79B8FF;">code2ProtocolConverter</span><span style="color:#B392F0;">.asVersionedTextDocumentIdentifier(</span></span>
<span class="line"><span style="color:#B392F0;">        document</span></span>
<span class="line"><span style="color:#B392F0;">      )</span><span style="color:#BBBBBB;">,</span></span>
<span class="line"><span style="color:#B392F0;">    tags</span></span>
<span class="line"><span style="color:#B392F0;">  };</span></span>
<span class="line"><span style="color:#B392F0;">  </span><span style="color:#F97583;">return</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">languageClientProxy</span><span style="color:#B392F0;">.sendRequest(autoRenameTagRequestType</span><span style="color:#BBBBBB;">,</span><span style="color:#B392F0;"> params);</span></span>
<span class="line"><span style="color:#B392F0;">};</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><code>doAutoCompletionElementRenameTag</code>函数中调用</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki one-dark-pro vp-code-dark" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">results</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">await</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">askServerForAutoCompletionsElementRenameTag</span><span style="color:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#E06C75;">languageClientProxy</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#E5C07B;">vscode</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">window</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">activeTextEditor</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">document</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#E06C75;">tags</span></span>
<span class="line"><span style="color:#ABB2BF;">  );</span></span>
<span class="line"></span></code></pre><pre class="shiki min-dark vp-code-light" tabindex="0"><code><span class="line"><span style="color:#B392F0;">  </span><span style="color:#F97583;">const</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">results</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">await</span><span style="color:#B392F0;"> askServerForAutoCompletionsElementRenameTag(</span></span>
<span class="line"><span style="color:#B392F0;">    languageClientProxy</span><span style="color:#BBBBBB;">,</span></span>
<span class="line"><span style="color:#B392F0;">    </span><span style="color:#79B8FF;">vscode</span><span style="color:#B392F0;">.</span><span style="color:#79B8FF;">window</span><span style="color:#B392F0;">.</span><span style="color:#79B8FF;">activeTextEditor</span><span style="color:#B392F0;">.document</span><span style="color:#BBBBBB;">,</span></span>
<span class="line"><span style="color:#B392F0;">    tags</span></span>
<span class="line"><span style="color:#B392F0;">  );</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>客户端<code>languageClientProxy.sendRequest</code>发送请求，那么再看下服务端<code>server/serverMain.ts</code>怎么接受请求</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki one-dark-pro vp-code-dark" tabindex="0"><code><span class="line"><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">handleRequest</span><span style="color:#ABB2BF;">: &lt;</span><span style="color:#E5C07B;">Params</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">Result</span><span style="color:#ABB2BF;">&gt;(</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#61AFEF;">fn</span><span style="color:#ABB2BF;">: (</span><span style="color:#E06C75;font-style:italic;">params</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Params</span><span style="color:#ABB2BF;">) </span><span style="color:#C678DD;">=&gt;</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">Result</span></span>
<span class="line"><span style="color:#ABB2BF;">) </span><span style="color:#C678DD;">=&gt;</span><span style="color:#ABB2BF;"> (</span><span style="color:#E06C75;font-style:italic;">params</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Params</span><span style="color:#ABB2BF;">) </span><span style="color:#C678DD;">=&gt;</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">Result</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;font-style:italic;">fn</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">=&gt;</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;font-style:italic;">params</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">=&gt;</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">try</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">return</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">fn</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">params</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">  } </span><span style="color:#C678DD;">catch</span><span style="color:#ABB2BF;"> (</span><span style="color:#E06C75;">error</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#61AFEF;">handleError</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">error</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">throw</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">error</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">  }</span></span>
<span class="line"><span style="color:#ABB2BF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B;">connection</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">onRequest</span><span style="color:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#E06C75;">autoRenameTagRequestType</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#61AFEF;">handleRequest</span><span style="color:#ABB2BF;">(</span><span style="color:#61AFEF;">autoRenameTag</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">documents</span><span style="color:#ABB2BF;">))</span></span>
<span class="line"><span style="color:#ABB2BF;">);</span></span>
<span class="line"></span></code></pre><pre class="shiki min-dark vp-code-light" tabindex="0"><code><span class="line"><span style="color:#F97583;">const</span><span style="color:#B392F0;"> handleRequest</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> &lt;Params</span><span style="color:#BBBBBB;">,</span><span style="color:#B392F0;"> Result&gt;(</span></span>
<span class="line"><span style="color:#B392F0;">  fn</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> (params</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> Params) </span><span style="color:#F97583;">=&gt;</span><span style="color:#B392F0;"> Result</span></span>
<span class="line"><span style="color:#B392F0;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#B392F0;"> (params</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> Params) </span><span style="color:#F97583;">=&gt;</span><span style="color:#B392F0;"> Result </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> fn </span><span style="color:#F97583;">=&gt;</span><span style="color:#B392F0;"> params </span><span style="color:#F97583;">=&gt;</span><span style="color:#B392F0;"> {</span></span>
<span class="line"><span style="color:#B392F0;">  </span><span style="color:#F97583;">try</span><span style="color:#B392F0;"> {</span></span>
<span class="line"><span style="color:#B392F0;">    </span><span style="color:#F97583;">return</span><span style="color:#B392F0;"> fn(params);</span></span>
<span class="line"><span style="color:#B392F0;">  } </span><span style="color:#F97583;">catch</span><span style="color:#B392F0;"> (error) {</span></span>
<span class="line"><span style="color:#B392F0;">    handleError(error);</span></span>
<span class="line"><span style="color:#B392F0;">    </span><span style="color:#F97583;">throw</span><span style="color:#B392F0;"> error;</span></span>
<span class="line"><span style="color:#B392F0;">  }</span></span>
<span class="line"><span style="color:#B392F0;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF;">connection</span><span style="color:#B392F0;">.onRequest(</span></span>
<span class="line"><span style="color:#B392F0;">  autoRenameTagRequestType</span><span style="color:#BBBBBB;">,</span></span>
<span class="line"><span style="color:#B392F0;">  handleRequest(autoRenameTag(documents))</span></span>
<span class="line"><span style="color:#B392F0;">);</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>最后再来看下<code>autoRenameTag</code>方法，流程上结束了，至于<code>doAutoRenameTag</code>的具体实现，就不在这里介绍了</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki one-dark-pro vp-code-dark" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">// 这里的ts类型是( documents: TextDocuments&lt;TextDocument&gt; ) =&gt; (params: Params) =&gt; Promise&lt;Result[]&gt;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// 表示该函数接受一个 documents 参数，然后返回一个函数，返回的函数接受一个 params 参数，返回一个 Promise，解析为 Result[] 数组。</span></span>
<span class="line"><span style="color:#C678DD;">export</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">autoRenameTag</span><span style="color:#ABB2BF;">: (</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#E06C75;font-style:italic;">documents</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">TextDocuments</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">TextDocument</span><span style="color:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF;">) </span><span style="color:#C678DD;">=&gt;</span><span style="color:#ABB2BF;"> (</span><span style="color:#E06C75;font-style:italic;">params</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Params</span><span style="color:#ABB2BF;">) </span><span style="color:#C678DD;">=&gt;</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">Promise</span><span style="color:#ABB2BF;">&lt;</span><span style="color:#E5C07B;">Result</span><span style="color:#ABB2BF;">[]&gt; </span><span style="color:#56B6C2;">=</span></span>
<span class="line"><span style="color:#ABB2BF;">  (</span><span style="color:#E06C75;font-style:italic;">documents</span><span style="color:#ABB2BF;">) </span><span style="color:#C678DD;">=&gt;</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#7F848E;font-style:italic;">// 解构赋值获取 params 参数中的 textDocument, tags</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">async</span><span style="color:#ABB2BF;"> ({ </span><span style="color:#E06C75;font-style:italic;">textDocument</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;font-style:italic;">tags</span><span style="color:#ABB2BF;"> }) </span><span style="color:#C678DD;">=&gt;</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">await</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">new</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">Promise</span><span style="color:#ABB2BF;">((</span><span style="color:#E06C75;font-style:italic;">r</span><span style="color:#ABB2BF;">) </span><span style="color:#C678DD;">=&gt;</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">setTimeout</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">r</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">20</span><span style="color:#ABB2BF;">));</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">document</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">documents</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">get</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">textDocument</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">uri</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#E06C75;">document</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">return</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">NULL_AUTO_RENAME_TAG_RESULT</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">      }</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (</span><span style="color:#E5C07B;">textDocument</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">version</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">!==</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">document</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">version</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">return</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">NULL_AUTO_RENAME_TAG_RESULT</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">      }</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">text</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">document</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">getText</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">results</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Result</span><span style="color:#ABB2BF;">[] </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">tags</span></span>
<span class="line"><span style="color:#ABB2BF;">        .</span><span style="color:#61AFEF;">map</span><span style="color:#ABB2BF;">((</span><span style="color:#E06C75;font-style:italic;">tag</span><span style="color:#ABB2BF;">) </span><span style="color:#C678DD;">=&gt;</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#ABB2BF;">          </span><span style="color:#7F848E;font-style:italic;">// service中定义的doAutoRenameTag方法</span></span>
<span class="line"><span style="color:#ABB2BF;">          </span><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">result</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">doAutoRenameTag</span><span style="color:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#ABB2BF;">            </span><span style="color:#E06C75;">text</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">            </span><span style="color:#E5C07B;">tag</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">offset</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">            </span><span style="color:#E5C07B;">tag</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">word</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">            </span><span style="color:#E5C07B;">tag</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">oldWord</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">            </span><span style="color:#E5C07B;">document</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">languageId</span></span>
<span class="line"><span style="color:#ABB2BF;">          );</span></span>
<span class="line"><span style="color:#ABB2BF;">          </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#E06C75;">result</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">            </span><span style="color:#C678DD;">return</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">result</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">          }</span></span>
<span class="line"><span style="color:#ABB2BF;">          (</span><span style="color:#E06C75;">result</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">as</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">any</span><span style="color:#ABB2BF;">).</span><span style="color:#E06C75;">originalOffset</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">tag</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">offset</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">          (</span><span style="color:#E06C75;">result</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">as</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">any</span><span style="color:#ABB2BF;">).</span><span style="color:#E06C75;">originalWord</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">tag</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">word</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">          </span><span style="color:#C678DD;">return</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">result</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">as</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">Result</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">        })</span></span>
<span class="line"><span style="color:#ABB2BF;">        .</span><span style="color:#61AFEF;">filter</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">Boolean</span><span style="color:#ABB2BF;">) </span><span style="color:#C678DD;">as</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">Result</span><span style="color:#ABB2BF;">[];</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">return</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">results</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">    };</span></span>
<span class="line"></span></code></pre><pre class="shiki min-dark vp-code-light" tabindex="0"><code><span class="line"><span style="color:#6B737C;">// 这里的ts类型是( documents: TextDocuments&lt;TextDocument&gt; ) =&gt; (params: Params) =&gt; Promise&lt;Result[]&gt;</span></span>
<span class="line"><span style="color:#6B737C;">// 表示该函数接受一个 documents 参数，然后返回一个函数，返回的函数接受一个 params 参数，返回一个 Promise，解析为 Result[] 数组。</span></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">const</span><span style="color:#B392F0;"> autoRenameTag</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> (</span></span>
<span class="line"><span style="color:#B392F0;">  documents</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> TextDocuments&lt;TextDocument&gt;</span></span>
<span class="line"><span style="color:#B392F0;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#B392F0;"> (params</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> Params) </span><span style="color:#F97583;">=&gt;</span><span style="color:#B392F0;"> Promise&lt;Result[]&gt; </span><span style="color:#F97583;">=</span></span>
<span class="line"><span style="color:#B392F0;">  (documents) </span><span style="color:#F97583;">=&gt;</span></span>
<span class="line"><span style="color:#B392F0;">    </span><span style="color:#6B737C;">// 解构赋值获取 params 参数中的 textDocument, tags</span></span>
<span class="line"><span style="color:#B392F0;">    </span><span style="color:#F97583;">async</span><span style="color:#B392F0;"> ({ textDocument</span><span style="color:#BBBBBB;">,</span><span style="color:#B392F0;"> tags }) </span><span style="color:#F97583;">=&gt;</span><span style="color:#B392F0;"> {</span></span>
<span class="line"><span style="color:#B392F0;">      </span><span style="color:#F97583;">await</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">new</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">Promise</span><span style="color:#B392F0;">((r) </span><span style="color:#F97583;">=&gt;</span><span style="color:#B392F0;"> setTimeout(r</span><span style="color:#BBBBBB;">,</span><span style="color:#B392F0;"> </span><span style="color:#F8F8F8;">20</span><span style="color:#B392F0;">));</span></span>
<span class="line"><span style="color:#B392F0;">      </span><span style="color:#F97583;">const</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">document</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">documents</span><span style="color:#B392F0;">.get(</span><span style="color:#79B8FF;">textDocument</span><span style="color:#B392F0;">.uri);</span></span>
<span class="line"><span style="color:#B392F0;">      </span><span style="color:#F97583;">if</span><span style="color:#B392F0;"> (</span><span style="color:#F97583;">!</span><span style="color:#B392F0;">document) {</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#F97583;">return</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">NULL_AUTO_RENAME_TAG_RESULT</span><span style="color:#B392F0;">;</span></span>
<span class="line"><span style="color:#B392F0;">      }</span></span>
<span class="line"><span style="color:#B392F0;">      </span><span style="color:#F97583;">if</span><span style="color:#B392F0;"> (</span><span style="color:#79B8FF;">textDocument</span><span style="color:#B392F0;">.version </span><span style="color:#F97583;">!==</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">document</span><span style="color:#B392F0;">.version) {</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#F97583;">return</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">NULL_AUTO_RENAME_TAG_RESULT</span><span style="color:#B392F0;">;</span></span>
<span class="line"><span style="color:#B392F0;">      }</span></span>
<span class="line"><span style="color:#B392F0;">      </span><span style="color:#F97583;">const</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">text</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">document</span><span style="color:#B392F0;">.getText();</span></span>
<span class="line"><span style="color:#B392F0;">      </span><span style="color:#F97583;">const</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">results</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> Result[] </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> tags</span></span>
<span class="line"><span style="color:#B392F0;">        .map((tag) </span><span style="color:#F97583;">=&gt;</span><span style="color:#B392F0;"> {</span></span>
<span class="line"><span style="color:#B392F0;">          </span><span style="color:#6B737C;">// service中定义的doAutoRenameTag方法</span></span>
<span class="line"><span style="color:#B392F0;">          </span><span style="color:#F97583;">const</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">result</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> doAutoRenameTag(</span></span>
<span class="line"><span style="color:#B392F0;">            text</span><span style="color:#BBBBBB;">,</span></span>
<span class="line"><span style="color:#B392F0;">            </span><span style="color:#79B8FF;">tag</span><span style="color:#B392F0;">.offset</span><span style="color:#BBBBBB;">,</span></span>
<span class="line"><span style="color:#B392F0;">            </span><span style="color:#79B8FF;">tag</span><span style="color:#B392F0;">.word</span><span style="color:#BBBBBB;">,</span></span>
<span class="line"><span style="color:#B392F0;">            </span><span style="color:#79B8FF;">tag</span><span style="color:#B392F0;">.oldWord</span><span style="color:#BBBBBB;">,</span></span>
<span class="line"><span style="color:#B392F0;">            </span><span style="color:#79B8FF;">document</span><span style="color:#B392F0;">.languageId</span></span>
<span class="line"><span style="color:#B392F0;">          );</span></span>
<span class="line"><span style="color:#B392F0;">          </span><span style="color:#F97583;">if</span><span style="color:#B392F0;"> (</span><span style="color:#F97583;">!</span><span style="color:#B392F0;">result) {</span></span>
<span class="line"><span style="color:#B392F0;">            </span><span style="color:#F97583;">return</span><span style="color:#B392F0;"> result;</span></span>
<span class="line"><span style="color:#B392F0;">          }</span></span>
<span class="line"><span style="color:#B392F0;">          (result </span><span style="color:#F97583;">as</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">any</span><span style="color:#B392F0;">).originalOffset </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">tag</span><span style="color:#B392F0;">.offset;</span></span>
<span class="line"><span style="color:#B392F0;">          (result </span><span style="color:#F97583;">as</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">any</span><span style="color:#B392F0;">).originalWord </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">tag</span><span style="color:#B392F0;">.word;</span></span>
<span class="line"><span style="color:#B392F0;">          </span><span style="color:#F97583;">return</span><span style="color:#B392F0;"> result </span><span style="color:#F97583;">as</span><span style="color:#B392F0;"> Result;</span></span>
<span class="line"><span style="color:#B392F0;">        })</span></span>
<span class="line"><span style="color:#B392F0;">        .filter(Boolean) </span><span style="color:#F97583;">as</span><span style="color:#B392F0;"> Result[];</span></span>
<span class="line"><span style="color:#B392F0;">      </span><span style="color:#F97583;">return</span><span style="color:#B392F0;"> results;</span></span>
<span class="line"><span style="color:#B392F0;">    };</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><h2 id="updatewordsatoffset-更新标签信息的函数" tabindex="-1">updateWordsAtOffset：更新标签信息的函数 <a class="header-anchor" href="#updatewordsatoffset-更新标签信息的函数" aria-hidden="true">#</a></h2><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki one-dark-pro vp-code-dark" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">// 更新标签信息的函数</span></span>
<span class="line"><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">updateWordsAtOffset</span><span style="color:#ABB2BF;">: (</span><span style="color:#E06C75;font-style:italic;">tags</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">Tag</span><span style="color:#ABB2BF;">[]) </span><span style="color:#C678DD;">=&gt;</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">void</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;font-style:italic;">tags</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">=&gt;</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">keys</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">Object</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">keys</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">wordsAtOffsets</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (</span><span style="color:#E5C07B;">keys</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">length</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">&gt;</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (</span><span style="color:#E5C07B;">keys</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">length</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">!==</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">tags</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">length</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#E06C75;">wordsAtOffsets</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> {};</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">for</span><span style="color:#ABB2BF;"> (</span><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">tag</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">of</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">tags</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (</span><span style="color:#56B6C2;">!</span><span style="color:#E5C07B;">wordsAtOffsets</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">hasOwnProperty</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">tag</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">previousOffset</span><span style="color:#ABB2BF;">)) {</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#E06C75;">wordsAtOffsets</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> {};</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">break</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">      }</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#ABB2BF;">  }</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">for</span><span style="color:#ABB2BF;"> (</span><span style="color:#C678DD;">const</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">tag</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">of</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">tags</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#E06C75;">wordsAtOffsets</span><span style="color:#ABB2BF;">[</span><span style="color:#E5C07B;">tag</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">offset</span><span style="color:#ABB2BF;">] </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#E06C75;">oldWord</span><span style="color:#ABB2BF;">:</span></span>
<span class="line"><span style="color:#ABB2BF;">        (</span><span style="color:#E06C75;">wordsAtOffsets</span><span style="color:#ABB2BF;">[</span><span style="color:#E5C07B;">tag</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">previousOffset</span><span style="color:#ABB2BF;">] </span><span style="color:#56B6C2;">&amp;&amp;</span></span>
<span class="line"><span style="color:#ABB2BF;">          </span><span style="color:#E06C75;">wordsAtOffsets</span><span style="color:#ABB2BF;">[</span><span style="color:#E5C07B;">tag</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">previousOffset</span><span style="color:#ABB2BF;">].</span><span style="color:#E06C75;">oldWord</span><span style="color:#ABB2BF;">) </span><span style="color:#56B6C2;">||</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#E5C07B;">tag</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">oldWord</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#E06C75;">newWord</span><span style="color:#ABB2BF;">: </span><span style="color:#E5C07B;">tag</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">word</span></span>
<span class="line"><span style="color:#ABB2BF;">    };</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (</span><span style="color:#E5C07B;">tag</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">previousOffset</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">!==</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">tag</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">offset</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">delete</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">wordsAtOffsets</span><span style="color:#ABB2BF;">[</span><span style="color:#E5C07B;">tag</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">previousOffset</span><span style="color:#ABB2BF;">];</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#E5C07B;">tag</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">oldWord</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">wordsAtOffsets</span><span style="color:#ABB2BF;">[</span><span style="color:#E5C07B;">tag</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">offset</span><span style="color:#ABB2BF;">].</span><span style="color:#E06C75;">oldWord</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">  }</span></span>
<span class="line"><span style="color:#ABB2BF;">};</span></span>
<span class="line"></span></code></pre><pre class="shiki min-dark vp-code-light" tabindex="0"><code><span class="line"><span style="color:#6B737C;">// 更新标签信息的函数</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#B392F0;"> updateWordsAtOffset</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> (tags</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> Tag[]) </span><span style="color:#F97583;">=&gt;</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">void</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> tags </span><span style="color:#F97583;">=&gt;</span><span style="color:#B392F0;"> {</span></span>
<span class="line"><span style="color:#B392F0;">  </span><span style="color:#F97583;">const</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">keys</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">Object</span><span style="color:#B392F0;">.keys(wordsAtOffsets);</span></span>
<span class="line"><span style="color:#B392F0;">  </span><span style="color:#F97583;">if</span><span style="color:#B392F0;"> (</span><span style="color:#79B8FF;">keys</span><span style="color:#B392F0;">.</span><span style="color:#79B8FF;">length</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#B392F0;"> </span><span style="color:#F8F8F8;">0</span><span style="color:#B392F0;">) {</span></span>
<span class="line"><span style="color:#B392F0;">    </span><span style="color:#F97583;">if</span><span style="color:#B392F0;"> (</span><span style="color:#79B8FF;">keys</span><span style="color:#B392F0;">.</span><span style="color:#79B8FF;">length</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">!==</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">tags</span><span style="color:#B392F0;">.</span><span style="color:#79B8FF;">length</span><span style="color:#B392F0;">) {</span></span>
<span class="line"><span style="color:#B392F0;">      wordsAtOffsets </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> {};</span></span>
<span class="line"><span style="color:#B392F0;">    }</span></span>
<span class="line"><span style="color:#B392F0;">    </span><span style="color:#F97583;">for</span><span style="color:#B392F0;"> (</span><span style="color:#F97583;">const</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">tag</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">of</span><span style="color:#B392F0;"> tags) {</span></span>
<span class="line"><span style="color:#B392F0;">      </span><span style="color:#F97583;">if</span><span style="color:#B392F0;"> (</span><span style="color:#F97583;">!</span><span style="color:#79B8FF;">wordsAtOffsets</span><span style="color:#B392F0;">.hasOwnProperty(</span><span style="color:#79B8FF;">tag</span><span style="color:#B392F0;">.previousOffset)) {</span></span>
<span class="line"><span style="color:#B392F0;">        wordsAtOffsets </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> {};</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#F97583;">break</span><span style="color:#B392F0;">;</span></span>
<span class="line"><span style="color:#B392F0;">      }</span></span>
<span class="line"><span style="color:#B392F0;">    }</span></span>
<span class="line"><span style="color:#B392F0;">  }</span></span>
<span class="line"><span style="color:#B392F0;">  </span><span style="color:#F97583;">for</span><span style="color:#B392F0;"> (</span><span style="color:#F97583;">const</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">tag</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">of</span><span style="color:#B392F0;"> tags) {</span></span>
<span class="line"><span style="color:#B392F0;">    wordsAtOffsets[</span><span style="color:#79B8FF;">tag</span><span style="color:#B392F0;">.offset] </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> {</span></span>
<span class="line"><span style="color:#B392F0;">      oldWord</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#B392F0;">        (wordsAtOffsets[</span><span style="color:#79B8FF;">tag</span><span style="color:#B392F0;">.previousOffset] </span><span style="color:#F97583;">&amp;&amp;</span></span>
<span class="line"><span style="color:#B392F0;">          wordsAtOffsets[</span><span style="color:#79B8FF;">tag</span><span style="color:#B392F0;">.previousOffset].oldWord) </span><span style="color:#F97583;">||</span></span>
<span class="line"><span style="color:#B392F0;">        </span><span style="color:#79B8FF;">tag</span><span style="color:#B392F0;">.oldWord</span><span style="color:#BBBBBB;">,</span></span>
<span class="line"><span style="color:#B392F0;">      newWord</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">tag</span><span style="color:#B392F0;">.word</span></span>
<span class="line"><span style="color:#B392F0;">    };</span></span>
<span class="line"><span style="color:#B392F0;">    </span><span style="color:#F97583;">if</span><span style="color:#B392F0;"> (</span><span style="color:#79B8FF;">tag</span><span style="color:#B392F0;">.previousOffset </span><span style="color:#F97583;">!==</span><span style="color:#B392F0;"> </span><span style="color:#79B8FF;">tag</span><span style="color:#B392F0;">.offset) {</span></span>
<span class="line"><span style="color:#B392F0;">      </span><span style="color:#F97583;">delete</span><span style="color:#B392F0;"> wordsAtOffsets[</span><span style="color:#79B8FF;">tag</span><span style="color:#B392F0;">.previousOffset];</span></span>
<span class="line"><span style="color:#B392F0;">    }</span></span>
<span class="line"><span style="color:#B392F0;">    </span><span style="color:#79B8FF;">tag</span><span style="color:#B392F0;">.oldWord </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> wordsAtOffsets[</span><span style="color:#79B8FF;">tag</span><span style="color:#B392F0;">.offset].oldWord;</span></span>
<span class="line"><span style="color:#B392F0;">  }</span></span>
<span class="line"><span style="color:#B392F0;">};</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div>`,28),e=[o];function t(c,r,B,y,F,i){return n(),a("div",null,e)}const C=s(p,[["render",t]]);export{u as __pageData,C as default};

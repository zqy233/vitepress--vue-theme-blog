# 分支操作

分支用于多人协同开发项目，每个人都在自己的分支下开发代码，开发完成后合并至主分支，从而不影响各自的开发

切换分支前需要先git commit或git stash，不然会自动合并

```sh
# 查看所有分支
git branch 
# 查看远程所有分支
git branch -r 
# 查看本地和远程的所有分支
git branch -a
# 新建分支
git branch <branchname>

# 重命名本地分支
git branch -m <oldbranch> <newbranch>
# 查看本地所有分支与远程分支的映射关系
git branch -vv  
# 撤销本地当前分支与远程分支的关系
git branch --unset-upstream    
# 建立本地当前分支与远程分支映射关系
git branch --set-upstream-to origin/<branchname> 
# 切换分支
git checkout  
# 切换并创建分支
git checkout -b <branchname> 

# git参数解释:
-d  --delete：删除
-D  --delete --force 强制删除
-f  --force：强制
-m  --move：移动或重命名
-M  --move --force 强制移动或重命名
-r  --remote：远程
-a  --all：所有
```

## 合并分支

### git merge

非常常见的使用场景：主分支master的代码不动，开发在dev分支开发，完成需求并测试没有bug后再合并dev分支的代码到主分支

在dev分支commit完回到主分支，会发现自己在dev分支写的代码回到master分支后全没了，要的就是这个效果，dev分支写的代码不影响主分支，然后使用git merge dev来合并dev的代码

如果在dev分支不commit直接回到主分支，会发现自己在dev分支写的代码master分支也出现了，dev分支写的代码影响了主分支，所以需要先commit再切换分支

```sh
git checkout -b dev
git commit -m "new feature"
git checkout master
git merge dev
```

### fatal: refusing to merge unrelated histories

两个仓库有不同的开始点，也就是两个仓库没有共同的 commit,出现无法提交的情况

```bash
git pull origin main --allow-unrelated-histories
```

### git rebase

git merge的缺点：当合并两个没有上下游关系的分支时，git会自动生成一个merge commit，记录此次的merge，该操作本身没有问题，问题是如果遇到特殊情况需要反复merge的时候，就会**导致commit的提交记录非常混乱**

为了解决这个头疼的问题，就需要用到rebase操作

rebase是一个非常强大的操作，可以实现一些神奇的功能，但是强大也意味着有隐患，所以在使用之前一定要先了解清楚原理，之后再小心谨慎地使用，否则很有可能会产生问题

首先说说rebase的功能，rebase的功能说白了可以**提取在A分支上的改动，然后应用在B分支的代码上**，完成类似于补丁的功能

比如，C1是线上的版本，在C1的代码上线了之后发现了一个bug，于是checkout了一个叫做bugFix的分支。与此同时还有新的功能在开发，新的功能提交到了master之后形成了节点C2。这个时候在bugFix分支当然可以merge master这没有什么问题，但是也可以rebase master

rebase masterd的结果就好像是**先到了C2然后checkout出了bugFix分支，然后在bugFix分支上将之前写过的代码重新写了一遍**，这样的操作就是`变基`，当rebase了之后再提交合并请求的合并记录里面会非常干净，没有多余merge的信息。对于多人协同开发的场景非常有帮助，具体命令如下

```sh
git checkout dev
git rebase master
git checkout master
git merge dev
```

### 代码未提交的情况下切换分支

应用场景：开发一个需求，还没开发完，这时来了一个更紧急的需求，需要先去实现这个需求

自然而然想要切换一个分支去实现，但切换分支操作会被拒绝，因为当前分支的更改内容没有提交至远程仓库，但我还没开发完，提交个der啊，所以这时就可以使用git stash了

git stash将当前分支的所有改动全部存起来，然后当前分支的项目就会biu的一下恢复到最后一次commit之前的代码了，这时就可以切换分支，去完成那个紧急的需求了

```sh
# 存储改动
git stash
# 查看存储的改动列表
git stash list
# 恢复改动
git stash apply
# 删除存储的改动列表
git stash drop 

# 或者使用，等价于apply和drop，直接恢复和删除
git stash pop 
```

## 提交至远程分支

创建远程新分支，需要本地新建分支，然后push时关联远程分支

```sh
# 新建一个分支并切换至
git checkout -b <branchname>
git add .
git commit -m "commitText"
# 提交该分支至远程仓库 --set-upstream表示本地关联远程分支
git push --set-upstream origin <branchname> 
# 是上方命令缩写
git push -u origin <branchname>   
```

已创建远程新分支，则切换到对应分支，直接push即可

```sh

git checkout <branchname>  
git add .
git commit -m "commitText"
# # 会直接push到本地分支同名的远程分支
git push 
```

## 删除远程分支

```sh
# 删除本地分支
git branch -d <branchname>

# 方法一，推送空分支到远程仓库
git push origin :<branchname> 
# 方法二，删除远程仓库分支
git push origin --delete <branchname> 
```

## 管理远程仓库地址

```sh
# 查看远程仓库地址
git remote -v 
# 添加远程仓库地址到本地仓库中，如已存在，会提示exist
git remote add origin https://git-repo-address.git   
# 修改远程仓库地址
git remote set-url origin https://git-repo-address.git  
# 删除远程仓库地址
git remote remove origin
```

